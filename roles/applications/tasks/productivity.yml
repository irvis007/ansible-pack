---
# Install productivity tools (no snap!)

# ============================================================================
# Setup: Create AppImage directories
# ============================================================================
- name: "[applications] Create AppImage directory"
  become: true
  ansible.builtin.file:
    path: "{{ appimage_install_dir }}"
    state: directory
    mode: '0755'
  when: obsidian_enabled | bool or pomotroid_enabled | bool

# ============================================================================
# Nextcloud Desktop Client (AppImage)
# ============================================================================
- name: "[applications] Check if Nextcloud is installed"
  ansible.builtin.stat:
    path: "{{ appimage_install_dir }}/Nextcloud.AppImage"
  register: nextcloud_check
  when: nextcloud_enabled | bool

- name: "[applications] Get latest Nextcloud version"
  ansible.builtin.uri:
    url: https://api.github.com/repos/nextcloud-releases/desktop/releases/latest
    return_content: true
  register: nextcloud_latest
  when: nextcloud_enabled | bool and not nextcloud_check.stat.exists

- name: "[applications] Download Nextcloud AppImage"
  ansible.builtin.get_url:
    url: "{{ nextcloud_latest.json.assets | selectattr('name', 'match', '.*\\.AppImage$') | map(attribute='browser_download_url') | first }}"
    dest: "{{ appimage_install_dir }}/Nextcloud.AppImage"
    mode: '0755'
  become: true
  when: nextcloud_enabled | bool and not nextcloud_check.stat.exists

- name: "[applications] Create Nextcloud symlink"
  become: true
  ansible.builtin.file:
    src: "{{ appimage_install_dir }}/Nextcloud.AppImage"
    dest: "{{ appimage_bin_dir }}/nextcloud"
    state: link
    follow: false
    force: yes
  when: nextcloud_enabled | bool

# ============================================================================
# Obsidian - Note-taking app (AppImage)
# ============================================================================
- name: "[applications] Check if Obsidian is installed"
  ansible.builtin.stat:
    path: "{{ appimage_install_dir }}/Obsidian.AppImage"
  register: obsidian_check
  when: obsidian_enabled | bool

- name: "[applications] Get latest Obsidian version"
  ansible.builtin.uri:
    url: https://api.github.com/repos/obsidianmd/obsidian-releases/releases/latest
    return_content: true
  register: obsidian_latest
  when: obsidian_enabled | bool and not obsidian_check.stat.exists

- name: "[applications] Download Obsidian AppImage"
  become: true
  ansible.builtin.get_url:
    url: "{{ obsidian_latest.json.assets | selectattr('name', 'match', '.*\\.AppImage$') | map(attribute='browser_download_url') | first }}"
    dest: "{{ appimage_install_dir }}/Obsidian.AppImage"
    mode: '0755'
  when:
    - obsidian_enabled | bool
    - not obsidian_check.stat.exists

- name: "[applications] Create Obsidian symlink"
  become: true
  ansible.builtin.file:
    src: "{{ appimage_install_dir }}/Obsidian.AppImage"
    dest: "{{ appimage_bin_dir }}/obsidian"
    state: link
    follow: false
  when: obsidian_enabled | bool

# ============================================================================
# Pomotroid - Pomodoro timer (AppImage from GitHub)
# ============================================================================
- name: "[applications] Check if Pomotroid is installed"
  ansible.builtin.stat:
    path: "{{ appimage_install_dir }}/Pomotroid.AppImage"
  register: pomotroid_check
  when: pomotroid_enabled | bool

- name: "[applications] Get latest Pomotroid version"
  ansible.builtin.uri:
    url: https://api.github.com/repos/Splode/pomotroid/releases/latest
    return_content: true
  register: pomotroid_latest
  when:
    - pomotroid_enabled | bool
    - not pomotroid_check.stat.exists

- name: "[applications] Download Pomotroid AppImage"
  become: true
  ansible.builtin.get_url:
    url: "{{ pomotroid_latest.json.assets | selectattr('name', 'match', '.*linux.*\\.AppImage$') | map(attribute='browser_download_url') | first }}"
    dest: "{{ appimage_install_dir }}/Pomotroid.AppImage"
    mode: '0755'
  when:
    - pomotroid_enabled | bool
    - not pomotroid_check.stat.exists

- name: "[applications] Create Pomotroid symlink"
  become: true
  ansible.builtin.file:
    src: "{{ appimage_install_dir }}/Pomotroid.AppImage"
    dest: "{{ appimage_bin_dir }}/pomotroid"
    state: link
    follow: false
  when: pomotroid_enabled | bool
