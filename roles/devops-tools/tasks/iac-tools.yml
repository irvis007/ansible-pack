# Install IaC tools

# ============================================================================
# Dependencies
# ============================================================================
- name: "[devops-tools] Ensure gnupg is installed for signature verification"
  become: true
  ansible.builtin.apt:
    name: gnupg
    state: present
    update_cache: no
  when: terragrunt_enabled | bool or terraform_enabled | bool

# ============================================================================
# Terraform, requieres asdf first
# ============================================================================
- name: "[devops-tools] Check if TF plugin is available in asdf vm"
  ansible.builtin.shell: |
    export PATH="{{ asdf_install_dir }}:${ASDF_DATA_DIR:-$HOME/.asdf}/shims:$PATH"
    asdf plugin list | grep -q terraform
  args:
    executable: /bin/bash
  register: terraform_plugin_check
  failed_when: false
  changed_when: false
  when:
    - terraform_enabled | bool
    - asdf_enabled | bool

- name: "[devops-tools] Add Terraform plugin with asdf"
  ansible.builtin.shell: |
    export PATH="{{ asdf_install_dir }}:${ASDF_DATA_DIR:-$HOME/.asdf}/shims:$PATH"
    asdf plugin add terraform
  args:
    executable: /bin/bash
  when:
    - terraform_enabled | bool
    - asdf_enabled | bool
    - terraform_plugin_check.rc != 0

- name: "[devops-tools] Install Terraform plugin with asdf"
  ansible.builtin.shell: |
    export PATH="{{ asdf_install_dir }}:${ASDF_DATA_DIR:-$HOME/.asdf}/shims:$PATH"
    asdf install terraform {{ terraform_version }}
  args:
    executable: /bin/bash
  when:
    - terraform_enabled | bool
    - asdf_enabled | bool
    - terraform_plugin_check.rc != 0

- name: "[devops-tools] Set user-level version for Terraform plugin with asdf"
  ansible.builtin.shell: |
    export PATH="{{ asdf_install_dir }}:${ASDF_DATA_DIR:-$HOME/.asdf}/shims:$PATH"
    asdf set --home terraform {{ terraform_version }}
  args:
    executable: /bin/bash
  when:
    - terraform_enabled | bool
    - asdf_enabled | bool
    - terraform_plugin_check.rc != 0

# ============================================================================
# Terragrunt, requieres asdf first
# ============================================================================
- name: "[devops-tools] Check if TG plugin is available in asdf vm"
  ansible.builtin.shell: |
    export PATH="{{ asdf_install_dir }}:${ASDF_DATA_DIR:-$HOME/.asdf}/shims:$PATH"
    asdf plugin list | grep -q terragrunt
  args:
    executable: /bin/bash
  register: terragrunt_plugin_check
  failed_when: false
  changed_when: false
  when:
    - terragrunt_enabled | bool
    - asdf_enabled | bool

- name: "[devops-tools] Add Terragrunt plugin with asdf"
  ansible.builtin.shell: |
    export PATH="{{ asdf_install_dir }}:${ASDF_DATA_DIR:-$HOME/.asdf}/shims:$PATH"
    asdf plugin add terragrunt
  args:
    executable: /bin/bash
  when:
    - terragrunt_enabled | bool
    - asdf_enabled | bool
    - terragrunt_plugin_check.rc != 0

- name: "[devops-tools] Install Terragrunt plugin with asdf"
  ansible.builtin.shell: |
    export PATH="{{ asdf_install_dir }}:${ASDF_DATA_DIR:-$HOME/.asdf}/shims:$PATH"
    asdf install terragrunt {{ terragrunt_version }}
  args:
    executable: /bin/bash
  when:
    - terragrunt_enabled | bool
    - asdf_enabled | bool
    - terragrunt_plugin_check.rc != 0

- name: "[devops-tools] Set user-level version for Terragrunt plugin with asdf"
  ansible.builtin.shell: |
    export PATH="{{ asdf_install_dir }}:${ASDF_DATA_DIR:-$HOME/.asdf}/shims:$PATH"
    asdf set --home terragrunt {{ terragrunt_version }}
  args:
    executable: /bin/bash
  when:
    - terragrunt_enabled | bool
    - asdf_enabled | bool
    - terragrunt_plugin_check.rc != 0
# ============================================================================
# Ansible, requieres asdf first
# ============================================================================
- name: "[devops-tools] Check if ansible plugin is available in asdf vm"
  ansible.builtin.shell: |
    export PATH="{{ asdf_install_dir }}:${ASDF_DATA_DIR:-$HOME/.asdf}/shims:$PATH"
    asdf plugin list | grep -q ansible
  args:
    executable: /bin/bash
  register: ansible_plugin_check
  failed_when: false
  changed_when: false
  when:
    - ansible_enabled | bool
    - asdf_enabled | bool

- name: "[devops-tools] Add Ansible plugin with asdf"
  ansible.builtin.shell: |
    export PATH="{{ asdf_install_dir }}:${ASDF_DATA_DIR:-$HOME/.asdf}/shims:$PATH"
    asdf plugin add ansible
  args:
    executable: /bin/bash
  when:
    - ansible_enabled | bool
    - asdf_enabled | bool
    - ansible_plugin_check.rc != 0

- name: "[devops-tools] Install Ansible plugin with asdf"
  ansible.builtin.shell: |
    export PATH="{{ asdf_install_dir }}:${ASDF_DATA_DIR:-$HOME/.asdf}/shims:$PATH"
    asdf install ansible {{ ansible_version }}
  args:
    executable: /bin/bash
  when:
    - ansible_enabled | bool
    - asdf_enabled | bool
    - ansible_plugin_check.rc != 0

- name: "[devops-tools] Set user-level version for Ansible plugin with asdf"
  ansible.builtin.shell: |
    export PATH="{{ asdf_install_dir }}:${ASDF_DATA_DIR:-$HOME/.asdf}/shims:$PATH"
    asdf set --home ansible {{ ansible_version }}
  args:
    executable: /bin/bash
  when:
    - ansible_enabled | bool
    - asdf_enabled | bool
    - ansible_plugin_check.rc != 0
